\newenvironment{simpletableinner}[1]{
	\taburowcolors 2{white .. gray!20}
	\begin{tabu}{#1}
}{
	\end{tabu}
}

\newenvironment{simpletable}[1]{
	\begin{center}
	\begin{simpletableinner}{#1}
}{
	\end{simpletableinner}
	\end{center}
}

\newcommand*\notedtable[3]{%Arguments: alignment, table, notes
	\begin{center}
		\begin{threeparttable}
			\begin{simpletableinner}{#1}
				#2
			\end{simpletableinner}
			\begin{tablenotes}
				#3
			\end{tablenotes}
		\end{threeparttable}
	\end{center}
}

\makeatletter
\newcommand{\labelname}[1]{\def\@currentlabelname{#1}}%Changes the name used by nameref on the next label.
\makeatother

\newcommand\partlabel[1]{\label{part:#1}}
\newcommand\chaplabel[1]{\label{chap:#1}}
\newcommand\seclabel[1]{\label{sec:#1}}
\newcommand\partref[1]{Part~\ref{part:#1}}
\newcommand\chapref[1]{Chapter~\ref{chap:#1}}
\newcommand\chapnameref[1]{\nameref{chap:#1}}
\newcommand\secref[1]{the \nameref{sec:#1} section}
\newcommand\secrefraw[1]{\nameref{sec:#1}}
\newcommand\seclink[2]{\hyperref[sec:#2]{#1}}

\newcommand\disclabel[3]{%Arguments: label, practitioner noun, practitioner plural
	\chaplabel{#1}%
	\labelname{#2}%
	\label{practitioner:#1}%
	\labelname{#3}%
	\label{practitioners:#1}%
	\labelname{#2's}%
	\label{practitionerpossessive:#1}%
}
\newcommand\discref[1]{\chapnameref{#1}}
\newcommand\practitioner[1]{\nameref{practitioner:#1}}
\newcommand\practitioners[1]{\nameref{practitioners:#1}}
\newcommand\practitionerpossessive[1]{\nameref{practitionerpossessive:#1}}

\newcommand\feat[5]{%Arguments: title, label, XP cost, prerequisites, text.
	\subsection[#1]{#1 [#3 XP]}
	\labelname{#1}
	\label{feat:#2}
	\index{#1}
	\textbf{Prerequisites:} {#4}
	
	{#5}
} %TODO: Tags such as 'first circle'?
\newcommand\featref[1]{\nameref{feat:#1}}
%TODO: Make feat references add the chapter in brackets afterwards, if the feat is in a different chapter.

\makeatletter
\newcommand\skill[3][\@nil]{%Takes three arguments, the first of which is optional and defaults to nothing.
	\def\govdisc{#1}
	\subsubsection{#2}%
	\label{skill:#3}%
	\ifx\govdisc\@nnil%
		%
	\else%
		Governing discipline: \discref{\govdisc}%TODO: This does really nasty things to the paragraphing.
	\fi%
}
\makeatother

\makeatletter
\newcommand\skillrefinner[2][\@nil]{%Takes two arguments, the first of which is optional and defaults to nothing.
	\def\numrank{#1}%
	#2%
	\ifx\numrank\@nnil%
		%
	\else%
		~#1%
	\fi%
}
\newcommand\skillref[2][\@nil]{%
	\skillrefinner[#1]{\nameref{skill:#2}}%
}
\newcommand\skillrefspeciality[3][\@nil]{%
	\skillrefinner[#1]{\nameref{skill:#2} (#3)}%
}
\makeatother

\newcommand\attribute[2]{%
	\subsection{#1}
	\label{attribute:#2}
}

\newcommand\attref[1]{%
	\nameref{attribute:#1}%
}

\newcommand\testtype[2]{%
	$\text{\skillref{#2}} + \text{\attref{#1}}$%
}
\newcommand\testtypespeciality[3]{%
	$\text{\skillrefspeciality{#2}{#3}} + \text{\attref{#1}}$%
}

\newcommand\statlabel[2]{%For derived statistics. Arguments: title, label
	\labelname{#1}%
	\label{stat:#2}%
}
\newcommand\statref[1]{%
	\nameref{stat:#1}%
}


\usepackage{amsfonts} %Gives the stuff we use to build \shortminus
\DeclareMathSymbol{\shortminus}{\mathbin}{AMSa}{"39}

\usepackage{xstring} %Gives \StrDel
\newcommand\dice[2][0]{%Takes two arguments, the first of which is optional and defaults to zero.
	#2d%
	\ifnum #1=0%
		%
	\else%
		\ifnum #1>0%
			$+$%
		\else%
			$\shortminus$%
		\fi%
		\StrDel{#1}{-}%Strips the minus from it, essentially giving absolute value.
	\fi%
}

\newcommand\negative[1]{$\shortminus$#1}
\newcommand\positive[1]{$+$#1}

\newcommand\atttable[8]{%Arguments: might, grace, ken, wit, will, heed, charm, presence
	\begin{center}
		\begin{tabu}{X[c]X[c]X[c]X[c]}
			\toprule
			
			\attref{might} &
			\attref{ken} &
			\attref{will} &
			\attref{charm} \\
			
			#1 & #3 & #5 & #7 \\
			
			\midrule
			
			\attref{grace} &
			\attref{wit} &
			\attref{heed} &
			\attref{presence} \\
			
			#2 & #4 & #6 & #8 \\
			
			\bottomrule
		\end{tabu}
	\end{center}
}

\makeatletter
\newcommand\statblock[8][\@nil]{%Arguments: displaytitle (optional), title, label, atttable, speed, skills, text, abilities
	\def\displaytitle{#1}
	\ifx\displaytitle\@nnil%
		\def\displaytitle{#2}%
	\fi%
	\subsection[#2]{\displaytitle}
	\labelname{#2}
	\label{#3}
	{#4}
	
	\textbf{Speed:} {#5}
	
	\nopagebreak
	\textbf{Skills:} {#6}
	
	\nopagebreak
	{#7}
	
	{#8}
}
\makeatother

\makeatletter
\newcommand\creature[8][\@nil]{%Arguments: displaytitle (optional), title, label, atttable, speed, skills, text, abilities
	\statblock[#1]{#2}{creature:#3}{#4}{#5}{#6}{#7}{#8}
}
\makeatother
\newcommand\speed[1]{%
	#1%
}
\newcommand\flyspeed[1]{%
	#1 flying%
}
\newcommand\swimspeed[1]{%
	#1 swimming%
}
\newcommand\ability[2]{%Arguments: title, text
	\textbf{#1:} {#2}%
}

\makeatletter
\newcommand\familiar[9][\@nil]{%Arguments: displaytitle, title, label, XP cost, atttable, speed, skills, text, abilities
	%TeX complains if we use \displaytitle for this, and then pass it to \statblock's \displaytitle.
	%So we use \displaytitleA here.
	\def\displaytitleA{#1}
	\ifx\displaytitleA\@nnil%
		\def\displaytitleA{#2}%
	\fi%
	\statblock[{\displaytitleA} {[#4 XP]}]{#2}{familiar:#3}{#5}{#6}{#7}{#8}{#9}
}
\makeatother
\newcommand\familiaroption[3]{%Arguments: title, XP cost, text
	\ability{{#1} [#2 XP]}{#3}
}

\newcommand\creatureref[1]{\nameref{creature:#1}}
\newcommand\familiarref[1]{\nameref{familiar:#1}}

\newcommand\materials[1]{%
	\textbf{Materials:} {#1}.%
}

\newcommand\herblabel[2]{%Arguments: title, label
	\labelname{#1 Herb}%
	\label{herb:#2}%
	\labelname{#1 Herbs}%
	\label{herbs:#2}%
	\labelname{#1}%
	\label{herbbare:#2}%
}

\newcommand\herbtype[1]{%A herb type (just rarity)
	\nameref{herb:#1}%
}
\newcommand\herbtypeplural[1]{%
	\nameref{herbs:#1}%
}
\newcommand\herbtypebare[1]{%
	\nameref{herbbare:#1}%
}

\makeatletter
\newcommand\herb[3][\@nil]{%A herb, with identity and type
	\def\akaname{#1}%Optional argument is an alternative name for the herb.
	#2 (%
	\ifx\akaname\@nnil%
		%
	\else%
		a.k.a.\ \akaname,\ %
	\fi%
	\herbtype{#3})%
}
\newcommand\herbs[2]{%
	#1 (\herbtypeplural{#2})%
}
\newcommand\Herb[3][\@nil]{%
	\def\akaname{#1}%
	\expandafter\MakeUppercase #2 (%
	\ifx\akaname\@nnil%
		%
	\else%
		a.k.a.\ \akaname,\ %
	\fi%
	\herbtype{#3})%
}
\newcommand\Herbs[2]{%
	\expandafter\MakeUppercase #1 (\herbtypeplural{#2})%
}
\makeatother

\newcommand\herbcreature[2]{%
	\herb{\creatureref{#1}}{#2}%
}


\newcommand\circlelabel[2]{%Arguments: title, label
	\labelname{#1 Ritual Circle}%
	\label{circle:#2}%
	\labelname{#1 Ritual Circles}%
	\label{circles:#2}%
}
\newcommand\circleref[1]{\nameref{circle:#1}}
\newcommand\circlerefplural[1]{\nameref{circles:#1}}

\newcommand\materiallabel[3]{%Arguments: title, plural title, label
	\labelname{#1}%
	\label{material:#3}%
	\labelname{#2}%
	\label{materials:#3}%
}
\newcommand\materialref[1]{\nameref{material:#1}}
\newcommand\materialrefplural[1]{\nameref{materials:#1}}

\newcommand\weaponlabel[3]{%Arguments: title, plural title, label
	\labelname{#1}%
	\label{weapon:#3}%
	\labelname{#2}%
	\label{weapons:#3}%
	\labelname{#1's}%
	\label{weaponpossessive:#3}%
}
\newcommand\weaponref[1]{\nameref{weapon:#1}}
\newcommand\weaponrefplural[1]{\nameref{weapons:#1}}
\newcommand\weaponrefpossessive[1]{\nameref{weaponpossessive:#1}}

\newcommand\actionlabel[1]{\label{action:#1}}
\newcommand\actionref[1]{\nameref{action:#1}}

\newcommand\undeadlabel[3]{%Arguments: title, plural title, label
	\labelname{#1}%
	\label{undead:#3}%
	\labelname{#2}%
	\label{undeads:#3}%
	\labelname{#1's}%
	\label{undeadpossessive:#3}%
}
\newcommand\undeadref[1]{\nameref{undead:#1}}
\newcommand\undeadrefplural[1]{\nameref{undeads:#1}}
\newcommand\undeadrefpossessive[1]{\nameref{undeadpossessive:#1}}

\newcommand\mixcreation[2]{%Arguments: name, label
	\subsubsection{#1}%
	\label{mixcreation:#2}%
}
\newcommand\mixdelivery[2]{%Arguments: name, label
	\subsubsection{#1}%
	\label{mixdelivery:#2}%
}

\newcommand\mix[3]{%Arguments: creation, delivery, ingredients
	\textbf{\nameref{mixdelivery:#2}}, \textbf{\nameref{mixcreation:#1}}, \materials{#3}
}
\newcommand\mixdeliveryref[1]{\nameref{mixdelivery:#1}}
\newcommand\mixcreationref[1]{\nameref{mixcreation:#1}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Argument-less seclink macros.
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\renewcommand\hat{\seclink{Hat}{the-hat}}
\newcommand\hats{\seclink{Hats}{the-hat}}

\newcommand\targetnumber{\seclink{Target Number}{target-numbers}}
\newcommand\targetnumbers{\seclink{Target Numbers}{target-numbers}}
\newcommand\tn{\seclink{TN}{target-numbers}}
\newcommand\tns{\seclink{TNs}{target-numbers}}

\newcommand\round{\seclink{Round}{structured-time}}
\newcommand\rounds{\seclink{Rounds}{structured-time}}
\newcommand\turn{\seclink{Turn}{structured-time}}
\newcommand\turns{\seclink{Turns}{structured-time}}
\newcommand\action{\seclink{Action}{structured-time}}
\newcommand\actions{\seclink{Actions}{structured-time}}

\newcommand\initiative{\seclink{Initiative}{initiative}}

\newcommand\damage{\seclink{Damage}{damage}}
\newcommand\shock{\seclink{Shock}{shock}}
\newcommand\shocked{\seclink{Shocked}{shock}}
\newcommand\exhaustion{\seclink{Exhaustion}{exhaustion}}

\newcommand\damagetest{\seclink{Damage Test}{damage-tests}}
\newcommand\damagetests{\seclink{Damage Tests}{damage-tests}}

\newcommand\fire{\seclink{Fire}{fire}}
\newcommand\ignite{\seclink{Ignite}{fire}}
\newcommand\ignited{\seclink{Ignited}{fire}}

\newcommand\opposedtest{\seclink{Opposed Test}{opposed-tests}}
\newcommand\opposedtests{\seclink{Opposed Tests}{opposed-tests}}
\newcommand\opposed{\seclink{opposed}{opposed-tests}}
\newcommand\Opposed{\seclink{Opposed}{opposed-tests}}

\newcommand\difficultterrain{\seclink{Difficult Terrain}{difficult-terrain}}

\renewcommand\symbol{\seclink{Symbol}{sympathetic-links}}
\renewcommand\symbols{\seclink{Symbols}{sympathetic-links}}
\newcommand\symbolpossessive{\seclink{Symbol's}{sympathetic-links}}
\newcommand\symlink{\seclink{Sympathetic Link}{sympathetic-links}}
\newcommand\symlinks{\seclink{Sympathetic Links}{sympathetic-links}}
\newcommand\stress{\seclink{Stress}{break-sympathetic-link}}
\newcommand\stressed{\seclink{Stressed}{break-sympathetic-link}}
\newcommand\stresses{\seclink{Stresses}{break-sympathetic-link}}
\newcommand\stressing{\seclink{Stressing}{break-sympathetic-link}}

\newcommand\mentalrealm{\seclink{Mental Realm}{the-mental-realm}}
\newcommand\lifeline{\seclink{Lifeline}{mental-lifeline}}
\newcommand\lifelines{\seclink{Lifelines}{mental-lifeline}}
\newcommand\possession{\seclink{Possession}{possession}}
\newcommand\possessed{\seclink{Possessed}{possession}}
\newcommand\possessing{\seclink{Possessing}{possession}}
\newcommand\possess{\seclink{Possess}{possession}}
\newcommand\possesses{\seclink{Possesses}{possession}}

\newcommand\phylactery{\seclink{Phylactery}{phylacteries}}
\newcommand\phylacteries{\seclink{Phylacteries}{phylacteries}}
\newcommand\phylacterypossessive{\seclink{Phylactery's}{phylacteries}}

\newcommand\souledrituals{\featref{animate-zombie}, \featref{animate-skeleton}, \featref{animate-ghoul}, or \featref{animate-fossil}}

\newcommand\augment{\seclink{Augment}{ritual-circle-augmentation}}
\newcommand\augmentation{\seclink{Augmentation}{ritual-circle-augmentation}}
\newcommand\augmentations{\seclink{Augmentations}{ritual-circle-augmentation}}
\newcommand\augmenting{\seclink{Augmenting}{ritual-circle-augmentation}}
\newcommand\augmented{\seclink{Augmented}{ritual-circle-augmentation}}

\newcommand\foretell{\seclink{Foretell}{foretelling}}
\newcommand\foretelling{\seclink{Foretelling}{foretelling}}
\newcommand\foretold{\seclink{Foretold}{foretelling}}

%%%%%%%%%%%%%%%%%%%%
%Aesthetic commands.
%%%%%%%%%%%%%%%%%%%%

\newcommand\titleemph[1]{\emph{#1}} %For the titles of books and such, including Coven itself.

\newcommand\storybreak{\bigskip}

\newcommand\storybreakword[1]{%
	\begin{center}%
		#1%
	\end{center}%
}

%Basing upon https://tex.stackexchange.com/a/199989
%Except using starred \chapter
%Starred chapter uses \@makeschapterhead instead of \@makechapterhead
\makeatletter
\newcommand\storychapter[1]{%
	\begingroup
	\let\@makeschapterhead\@gobble
	\chapter*{#1}
	\endgroup
}
\makeatother
